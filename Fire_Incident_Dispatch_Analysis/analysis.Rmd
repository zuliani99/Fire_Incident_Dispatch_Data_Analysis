---
title: "Fire Incident Dispatch Data Analysis"
author: "Zuliani Riccardo"
date: "12/12/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) #, cache=TRUE
setwd("C:/Users/ricca/Desktop/UNI/Magistrale/Anno3/Statistical_Inference_and_Learning/SIL Projcet/Statistical_Inference_Learning_Project/Fire_Incident_Dispatch_Analysis")

#install.packages("nnet")
#install.packages("jmv")
#install.packages("summarytools")

library(nnet)
library(jmv)
library(summarytools)
library(ggplot2)
```

# Fire Incident Dispatch Data Analysis
Read the restricted dataset of last 100k observation form the original 10.000.000 observations dataset
last 100k or 50k observation



```{r}
#last_50000 <- tail(read.csv("Fire_Incident_Dispatch_Data.csv"), 50000)

#write.csv(last_50000, file = "C:/Users/ricca/Desktop/UNI/Magistrale/Anno3/Statistical_Inference_and_Learning/SIL Projcet/Statistical_Inference_Learning_Project/Fire_Incident_Dispatch_Analysis/Fire_Incident_Dispatch_Data_last.csv", row.names = FALSE)
```



```{r read_data, cache=TRUE}
fire_data <- read.csv("Fire_Incident_Dispatch_Data_last_50k.csv")
summary(fire_data)
```

Check column before deleting them
```{r}
print(identical(fire_data$ALARM_BOX_BOROUGH, fire_data$INCIDENT_BOROUGH))
fire_data$VALID_DISPATCH_RSPNS_TIME_INDC <- as.factor(fire_data$VALID_DISPATCH_RSPNS_TIME_INDC)
print(summary(fire_data$VALID_DISPATCH_RSPNS_TIME_IND))
fire_data$VALID_INCIDENT_RSPNS_TIME_INDC <- as.factor(fire_data$VALID_INCIDENT_RSPNS_TIME_INDC)
print(summary(fire_data$VALID_INCIDENT_RSPNS_TIME_INDC))
```
So we can remove both involved columns with the additional DISPATCH_RESPONSE_SECONDS_QY

Remove some columns
```{r}
fire_data = subset(fire_data, select = -c(
  STARFIRE_INCIDENT_ID, INCIDENT_CLASSIFICATION, ALARM_BOX_BOROUGH,
  VALID_DISPATCH_RSPNS_TIME_INDC, DISPATCH_RESPONSE_SECONDS_QY
))
```

Set some factorials

```{r}
fire_data$INCIDENT_BOROUGH <- as.factor(fire_data$INCIDENT_BOROUGH)
fire_data$ALARM_SOURCE_DESCRIPTION_TX <- as.factor(fire_data$ALARM_SOURCE_DESCRIPTION_TX)
fire_data$ALARM_LEVEL_INDEX_DESCRIPTION <- as.factor(fire_data$ALARM_LEVEL_INDEX_DESCRIPTION)
fire_data$HIGHEST_ALARM_LEVEL <- as.factor(fire_data$HIGHEST_ALARM_LEVEL)

fire_data$INCIDENT_CLASSIFICATION_GROUP <- as.factor(fire_data$INCIDENT_CLASSIFICATION_GROUP)

# Li rimuovo lo rimuovo siccome il boolean Ã¨ sempre a false??????????
#fire_data$VALID_DISPATCH_RSPNS_TIME_INDC <- as.factor(fire_data$VALID_DISPATCH_RSPNS_TIME_INDC)
fire_data$VALID_INCIDENT_RSPNS_TIME_INDC <- as.factor(fire_data$VALID_INCIDENT_RSPNS_TIME_INDC)
levels(fire_data$VALID_INCIDENT_RSPNS_TIME_INDC)<- c("N", "Y")


# ALARM_BOX_LOCATION ---------------- DA MODELLARE MEGLIO

summary(fire_data)
```

Rename all the columns with a shorter and usable name
```{r}
names(fire_data) <- c("fire_datetime", "AL_number", "AL_loction", "incident_brough", "zip", "Pprecint", "citycouncil_dist", "community_dist", "comm_school_dist", "congressional_dist", "alarm_source_desc", "alarm_level_idx", "highest_alarm_lev", "incident_class", "first_ass_date", "first_act_date", "first_on_scene_date", "incident_close_date", "valid_inc_resp_time_indc", "incident_resp_sec", "incident_travel_time_sec", "engines_assigned", "ladders_assigned", "other_utits_assigned")
names(fire_data)
```



```{r}
summary(fire_data)
```

See the relation with the nan values, check if there is some patter or not
```{r}
summary(fire_data$valid_inc_resp_time_indc)
```

```{r}
tab_orig_incident_brough <- table(fire_data$incident_brough)
tab_orig_incident_brough
```



```{r}
non_valid_inc_resp <- subset(fire_data, valid_inc_resp_time_indc == "N")
tab_table_non_valid_inc_resp_incident_brough <- table(non_valid_inc_resp$incident_brough)
tab_table_non_valid_inc_resp_incident_brough
```

```{r}
for (variable in names(fire_data$incident_brough)) {
  print(variable)
  #print(tab_orig_incident_brough[variable] / tab_table_non_valid_inc_resp_incident_brough[variable])  
}
```

They all seems to be uniformly distribuited wrt the location


Removing all the nan from the dataset
```{r}
#fire_data[is.na(fire_data$ENGINES_ASSIGNED_QUANTITY),]

#commentare se ci sia un pattern nelle osservazioni nan

# prendere tutte le osservazioni che hanno un valid_inc_resp_time_indc
#fire_data <- fire_data[fire_data$valid_inc_resp_time_indc == ]

fire_data <- na.omit(fire_data)
summary(fire_data)
```

## Merging factor

```{r}
# incident class
#fire_data[fire_data$valid_inc_resp_time_indc ]

# the columns that have lots of factors


# let's try with highest_alarm_lev
#summary(fire_data$highest_alarm_lev)
fire_data$highest_alarm_lev_new <- fire_data$highest_alarm_lev
levels(fire_data$highest_alarm_lev_new) <- list("All Hands Working" = "All Hands Working",
                                                "First Alarm" = "First Alarm", 
                                                "Others" = c("Second Alarm", "Third Alarm"))
```

```{r}
fire_data <- subset(fire_data, select = -highest_alarm_lev)
summary(fire_data$highest_alarm_lev_new) # ERROREEEEEE
```



Train test split
```{r}
sample <- sample(c(TRUE, FALSE), nrow(fire_data), replace=TRUE, prob=c(0.7,0.3))
fire_data.train <- fire_data[sample, ]
fire_data.test <- fire_data[!sample, ]
fire_data.test <- subset(fire_data.test, select = -incident_class)
```


```{r}
#dfSummary(fire_data.train, style='grid', plain.ascii = FALSE, graph.col = FALSE)
```



# Molutinomial Logistic Regression
```{r}
#mod = multinom(incident_class ~ engines_assigned + ladders_assigned + incident_resp_sec + incident_brough + alarm_source_desc, data = fire_data.train, family = "binomial")
multi_nom_1 = multinom(incident_class ~ incident_resp_sec, data = fire_data.train, model=TRUE)
summary(multi_nom_1)
```

```{r}
# Check the Z-score for the model (wald Z)
z <- summary(multi_nom_1)$coefficients/summary(multi_nom_1)$standard.errors
z
```

```{r}
# 2-tailed z test
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
```


```{r}
# Test the goodness of fit
chisq.test(fire_data.train$incident_class,predict(multi_nom_1))
```

```{r}
exp(coef(multi_nom_1))
```

```{r}
library(summarytools)
ctable <- table(fire_data.train$incident_class,predict(multi_nom_1))
ctable
```

